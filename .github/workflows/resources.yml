name: List Files from Remote Repo

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  push:
    branches: [main]

env:
  REPO_OWNER: immortalwrt
  REPO_NAME: luci
  BRANCH: master
  TARGET_PATH: themes/luci-theme-bootstrap

jobs:
  list-files:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch and List All Files
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "======================================"
          echo "ğŸ“ ç›®æ ‡ä»“åº“: $REPO_OWNER/$REPO_NAME"
          echo "ğŸ“‚ ç›®æ ‡è·¯å¾„: $TARGET_PATH"
          echo "ğŸŒ¿ åˆ†æ”¯: $BRANCH"
          echo "======================================"
          
          # é€’å½’è·å–æ‰€æœ‰æ–‡ä»¶çš„å‡½æ•°
          fetch_contents() {
            local path="$1"
            local indent="$2"
            
            # è°ƒç”¨ GitHub API
            response=$(curl -s -H "Authorization: Bearer $GH_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/contents/$path?ref=$BRANCH")
            
            # æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯
            if echo "$response" | jq -e '.message' > /dev/null 2>&1; then
              echo "Error: $(echo "$response" | jq -r '.message')"
              return 1
            fi
            
            # éå†æ¯ä¸ªé¡¹ç›®
            echo "$response" | jq -c '.[]' | while read -r item; do
              name=$(echo "$item" | jq -r '.name')
              type=$(echo "$item" | jq -r '.type')
              item_path=$(echo "$item" | jq -r '.path')
              size=$(echo "$item" | jq -r '.size')
              download_url=$(echo "$item" | jq -r '.download_url')
              
              if [ "$type" = "file" ]; then
                echo "${indent}ğŸ“„ $name (${size} bytes)"
                echo "${indent}   â””â”€ Raw: $download_url"
                echo "$item_path|$download_url" >> /tmp/all_files.txt
              elif [ "$type" = "dir" ]; then
                echo "${indent}ğŸ“ $name/"
                # é€’å½’å¤„ç†å­ç›®å½•
                fetch_contents "$item_path" "${indent}   "
              fi
            done
          }
          
          echo ""
          echo "ğŸ“‹ ç›®å½•ç»“æ„ä¸åŸå§‹é“¾æ¥:"
          echo "--------------------------------------"
          
          # åˆå§‹åŒ–æ–‡ä»¶åˆ—è¡¨
          > /tmp/all_files.txt
          
          # å¼€å§‹é€’å½’è·å–
          fetch_contents "$TARGET_PATH" ""
          
          echo ""
          echo "======================================"
          echo "ğŸ“Š æ–‡ä»¶æ±‡æ€»è¡¨æ ¼"
          echo "======================================"
          
          if [ -f /tmp/all_files.txt ] && [ -s /tmp/all_files.txt ]; then
            echo ""
            echo "| æ–‡ä»¶è·¯å¾„ | åŸå§‹é“¾æ¥ |"
            echo "|----------|----------|"
            while IFS='|' read -r filepath rawurl; do
              # æå–ç›¸å¯¹è·¯å¾„
              relative_path="${filepath#$TARGET_PATH/}"
              echo "| \`$relative_path\` | [ä¸‹è½½]($rawurl) |"
            done < /tmp/all_files.txt
            
            echo ""
            echo "--------------------------------------"
            echo "ğŸ“ˆ æ€»è®¡: $(wc -l < /tmp/all_files.txt) ä¸ªæ–‡ä»¶"
          fi

      - name: Generate JSON Output
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo ""
          echo "======================================"
          echo "ğŸ“¦ JSON æ ¼å¼è¾“å‡º"
          echo "======================================"
          
          # ä½¿ç”¨ GitHub API è·å–æ ‘ç»“æ„ï¼ˆæ›´é«˜æ•ˆçš„æ–¹å¼ï¼‰
          # é¦–å…ˆè·å–æœ€æ–° commit SHA
          COMMIT_SHA=$(curl -s -H "Authorization: Bearer $GH_TOKEN" \
            "https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/commits/$BRANCH" \
            | jq -r '.sha')
          
          echo "ğŸ“Œ Commit SHA: $COMMIT_SHA"
          
          # è·å–æ•´ä¸ªæ ‘ç»“æ„
          TREE_SHA=$(curl -s -H "Authorization: Bearer $GH_TOKEN" \
            "https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/git/trees/$COMMIT_SHA?recursive=1" \
            | jq -r --arg path "$TARGET_PATH" '
              .tree 
              | map(select(.path | startswith($path))) 
              | map({
                  path: .path,
                  type: .type,
                  size: .size,
                  raw_url: (if .type == "blob" then "https://raw.githubusercontent.com/'"$REPO_OWNER"'/'"$REPO_NAME"'/'"$BRANCH"'/" + .path else null end)
                })
            ')
          
          echo "$TREE_SHA" | jq '.'

      - name: Save File List as Artifact
        run: |
          mkdir -p output
          
          # åˆ›å»ºæ–‡ä»¶åˆ—è¡¨
          if [ -f /tmp/all_files.txt ]; then
            cp /tmp/all_files.txt output/file_list.txt
          fi
          
          # åˆ›å»ºä¸€ä¸ªä¾¿äºä¸‹è½½çš„ shell è„šæœ¬
          echo "#!/bin/bash" > output/download_all.sh
          echo "# ä¸‹è½½æ‰€æœ‰æ–‡ä»¶çš„è„šæœ¬" >> output/download_all.sh
          echo "mkdir -p luci-theme-bootstrap" >> output/download_all.sh
          
          if [ -f /tmp/all_files.txt ]; then
            while IFS='|' read -r filepath rawurl; do
              relative_path="${filepath#$TARGET_PATH/}"
              dir_path=$(dirname "$relative_path")
              echo "mkdir -p \"luci-theme-bootstrap/$dir_path\" 2>/dev/null" >> output/download_all.sh
              echo "curl -sL \"$rawurl\" -o \"luci-theme-bootstrap/$relative_path\"" >> output/download_all.sh
            done < /tmp/all_files.txt
          fi
          
          chmod +x output/download_all.sh
          
          echo "ğŸ“¥ ä¸‹è½½è„šæœ¬å·²ç”Ÿæˆ: output/download_all.sh"

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: file-list-and-scripts
          path: output/
          retention-days: 7
