<!DOCTYPE html>
<html><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>vnt-cli è®¾ç½®</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background:#f5f5f5;color:#333}
.tabs{display:flex;background:#4a90d9}
.tab{padding:12px 24px;color:rgba(255,255,255,.8);cursor:pointer;font-weight:500;border-bottom:3px solid transparent}
.tab:hover{background:rgba(255,255,255,.1);color:#fff}
.tab.active{color:#fff;border-bottom-color:#fff;background:rgba(255,255,255,.15)}
.content{display:none;padding:20px;max-height:calc(100vh - 120px);overflow-y:auto}
.content.active{display:block}
.form-group{margin-bottom:16px}
.form-group>label{display:block;font-weight:500;margin-bottom:6px;color:#333}
.form-group input[type="text"],.form-group input[type="password"],.form-group select,.form-group textarea{width:100%;padding:10px 12px;border:1px solid #ccc;border-radius:4px;font-size:14px}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{border-color:#4a90d9;outline:none}
.form-row{display:flex;gap:15px}
.form-row .form-group{flex:1}
.form-check{display:flex;align-items:center;gap:8px;padding:8px 0}
.form-check input{width:18px;height:18px}
.form-tip{font-size:12px;color:#888;margin-top:4px}
.dlist{margin-top:8px}
.dlist-item{display:flex;gap:8px;margin-bottom:6px}
.dlist-item input{flex:1}
.dlist-item .del{padding:8px 12px;background:#dc3545;border:none;color:#fff;border-radius:4px;cursor:pointer}
.btn-add{padding:6px 12px;background:#6c757d;border:none;color:#fff;border-radius:4px;cursor:pointer;font-size:12px;margin-top:4px}
.footer{padding:15px 20px;background:#fff;border-top:1px solid #ddd;display:flex;justify-content:flex-end;gap:10px;position:sticky;bottom:0}
.btn{padding:10px 24px;border:none;border-radius:5px;cursor:pointer;font-weight:600;font-size:14px}
.btn-primary{background:linear-gradient(180deg,#4a90d9,#357abd);color:#fff}
.btn-primary:hover{background:linear-gradient(180deg,#5a9fe9,#4a90d9)}
.btn-secondary{background:#6c757d;color:#fff}
.upload-area{border:2px dashed #ccc;padding:20px;text-align:center;border-radius:8px;margin-bottom:15px}
.upload-area input{display:none}
.upload-area label{cursor:pointer;color:#4a90d9}
.upload-status{margin-top:10px;font-size:13px}
</style>
</head><body>
<div class="tabs">
    <div class="tab active" onclick="switchTab(0)">åŸºæœ¬è®¾ç½®</div>
    <div class="tab" onclick="switchTab(1)">é«˜çº§è®¾ç½®</div>
    <div class="tab" onclick="switchTab(2)">ä¸Šä¼ ç¨‹åº</div>
</div>

<div class="content active" id="tab0">
    <div class="form-check"><input type="checkbox" id="enabled"><label for="enabled">å¯ç”¨ vnt-cli</label></div>
    <div class="form-group"><label>Token</label><input type="password" id="token" placeholder="å¿…å¡«ï¼Œè™šæ‹Ÿå±€åŸŸç½‘æ ‡è¯†"><div class="form-tip">ç›¸åŒTokençš„è®¾å¤‡ä¼šç»„æˆä¸€ä¸ªè™šæ‹Ÿå±€åŸŸç½‘</div></div>
    <div class="form-row">
        <div class="form-group"><label>æ¥å£æ¨¡å¼</label><select id="mode" onchange="toggleMode()"><option value="dhcp">åŠ¨æ€åˆ†é…</option><option value="static">æ‰‹åŠ¨æŒ‡å®š</option></select></div>
        <div class="form-group" id="ipaddr_wrap" style="display:none"><label>æ¥å£IP</label><input type="text" id="ipaddr" placeholder="10.26.0.5"></div>
    </div>
    <div class="form-group"><label>è®¾å¤‡ID</label><input type="text" id="desvice_id" placeholder="å”¯ä¸€æ ‡è¯†ï¼Œä¸è¦é‡å¤"></div>
    <div class="form-group"><label>æœ¬åœ°ç½‘æ®µ</label><div class="dlist" id="localadd_list"></div><button type="button" class="btn-add" onclick="addItem('localadd')">+ æ·»åŠ </button><div class="form-tip">å¦‚192.168.1.0/24</div></div>
    <div class="form-group"><label>å¯¹ç«¯ç½‘æ®µ</label><div class="dlist" id="peeradd_list"></div><button type="button" class="btn-add" onclick="addItem('peeradd')">+ æ·»åŠ </button><div class="form-tip">æ ¼å¼: ç½‘æ®µ,å¯¹ç«¯IP å¦‚192.168.2.0/24,10.26.0.3</div></div>
    <div class="form-check"><input type="checkbox" id="forward"><label for="forward">å¯ç”¨IPè½¬å‘</label></div>
    <div class="form-check"><input type="checkbox" id="allow_wg"><label for="allow_wg">å…è®¸WireGuardæ¥å…¥</label></div>
    <div class="form-check"><input type="checkbox" id="log"><label for="log">å¯ç”¨æ—¥å¿—</label></div>
</div>

<div class="content" id="tab1">
    <div class="form-group"><label>ç¨‹åºè·¯å¾„</label><input type="text" id="clibin" placeholder="/usr/bin/vnt-cli"></div>
    <div class="form-group"><label>æœåŠ¡å™¨åœ°å€</label><input type="text" id="vntshost" placeholder="tcp://åŸŸå:ç«¯å£"><div class="form-tip">æ”¯æŒ udp:// tcp:// ws:// wss://</div></div>
    <div class="form-row">
        <div class="form-group"><label>è®¾å¤‡åç§°</label><input type="text" id="desvice_name"></div>
        <div class="form-group"><label>ç½‘å¡åç§°</label><input type="text" id="tunname" placeholder="vnt-tun"></div>
    </div>
    <div class="form-row">
        <div class="form-group"><label>ä¼ è¾“æ¨¡å¼</label><select id="relay"><option value="è‡ªåŠ¨">è‡ªåŠ¨</option><option value="è½¬å‘">è½¬å‘</option><option value="P2P">P2P</option></select></div>
        <div class="form-group"><label>æ‰“æ´æ¨¡å¼</label><select id="punch"><option value="all">éƒ½ä½¿ç”¨</option><option value="ipv4">ä»…IPv4</option><option value="ipv6">ä»…IPv6</option><option value="ipv4-tcp">ä»…IPv4-TCP</option><option value="ipv6-tcp">ä»…IPv6-TCP</option><option value="ipv4-udp">ä»…IPv4-UDP</option><option value="ipv6-udp">ä»…IPv6-UDP</option></select></div>
    </div>
    <div class="form-row">
        <div class="form-group"><label>åŠ å¯†æ¨¡å¼</label><select id="passmode" onchange="toggleKey()"><option value="off">ä¸åŠ å¯†</option><option value="aes_gcm">AES-GCM</option><option value="aes_cbc">AES-CBC</option><option value="aes_ecb">AES-ECB</option><option value="chacha20_poly1305">ChaCha20-Poly1305</option><option value="chacha20">ChaCha20</option><option value="sm4_cbc">SM4-CBC</option><option value="xor">XORæ··æ·†</option></select></div>
        <div class="form-group" id="key_wrap" style="display:none"><label>åŠ å¯†å¯†é’¥</label><input type="password" id="key"></div>
    </div>
    <div class="form-group"><label>DNSæœåŠ¡å™¨</label><div class="dlist" id="vntdns_list"></div><button type="button" class="btn-add" onclick="addItem('vntdns')">+ æ·»åŠ </button></div>
    <div class="form-group"><label>STUNæœåŠ¡å™¨</label><div class="dlist" id="stunhost_list"></div><button type="button" class="btn-add" onclick="addItem('stunhost')">+ æ·»åŠ </button></div>
    <div class="form-group"><label>ç«¯å£æ˜ å°„</label><div class="dlist" id="mapping_list"></div><button type="button" class="btn-add" onclick="addItem('mapping')">+ æ·»åŠ </button><div class="form-tip">æ ¼å¼: tcp:0.0.0.0:80->10.26.0.10:80</div></div>
    <div class="form-row">
        <div class="form-group"><label>æœ¬åœ°ç›‘å¬ç«¯å£</label><input type="text" id="client_port" placeholder="0,0"></div>
        <div class="form-group"><label>MTU</label><input type="text" id="mtu" placeholder="ç•™ç©ºè‡ªåŠ¨"></div>
    </div>
    <div class="form-group"><label>ç»‘å®šå‡ºå£ç½‘å¡</label><select id="local_dev"><option value="">ä¸ç»‘å®š</option></select></div>
    <div class="form-check"><input type="checkbox" id="serverw"><label for="serverw">æœåŠ¡ç«¯åŠ å¯†é€šä¿¡</label></div>
    <div class="form-check"><input type="checkbox" id="finger"><label for="finger">æ•°æ®æŒ‡çº¹æ ¡éªŒ</label></div>
    <div class="form-check"><input type="checkbox" id="first_latency"><label for="first_latency">ä¼˜åŒ–ä¼ è¾“(ä½å»¶è¿Ÿä¼˜å…ˆ)</label></div>
    <div class="form-check"><input type="checkbox" id="disable_stats"><label for="disable_stats">å¯ç”¨æµé‡ç»Ÿè®¡</label></div>
    <div class="form-check"><input type="checkbox" id="check" onchange="toggleCheck()"><label for="check">é€šæ–­æ£€æµ‹</label></div>
    <div id="check_wrap" style="display:none">
        <div class="form-group"><label>æ£€æµ‹IP</label><div class="dlist" id="checkip_list"></div><button type="button" class="btn-add" onclick="addItem('checkip')">+ æ·»åŠ </button></div>
        <div class="form-group"><label>æ£€æµ‹é—´éš”(åˆ†é’Ÿ)</label><select id="checktime"><% for i=1,60 do %><option value="<%=i%>"><%=i%></option><% end %></select></div>
    </div>
</div>

<div class="content" id="tab2">
    <div class="upload-area">
        <input type="file" id="upload_file" onchange="doUpload()">
        <label for="upload_file">ğŸ“ ç‚¹å‡»é€‰æ‹©æ–‡ä»¶æˆ–æ‹–æ‹½åˆ°æ­¤å¤„</label>
        <div class="form-tip">æ”¯æŒ vnt-cliã€vnts äºŒè¿›åˆ¶æ–‡ä»¶æˆ– .tar.gz å‹ç¼©åŒ…</div>
        <div class="upload-status" id="upload_status"></div>
    </div>
    <div class="form-tip">ä¸‹è½½åœ°å€: <a href="https://github.com/vnt-dev/vnt/releases" target="_blank">vnt-cli</a> | <a href="https://github.com/vnt-dev/vnts/releases" target="_blank">vnts</a></div>
</div>

<div class="footer">
    <button class="btn btn-secondary" onclick="parent.closeModal('settings')">å–æ¶ˆ</button>
    <button class="btn btn-primary" onclick="saveConfig()">ä¿å­˜å¹¶åº”ç”¨</button>
</div>

<script>
var cfg={},lists=['localadd','peeradd','vntdns','stunhost','mapping','checkip'];
function $(id){return document.getElementById(id)}
function ajax(url,cb,data){var x=new XMLHttpRequest();x.open(data?'POST':'GET',url,true);if(data)x.setRequestHeader('Content-Type','application/x-www-form-urlencoded');x.onload=function(){cb&&cb(x.responseText)};x.send(data)}

function switchTab(i){document.querySelectorAll('.tab').forEach(function(t,j){t.classList.toggle('active',j==i)});document.querySelectorAll('.content').forEach(function(c,j){c.classList.toggle('active',j==i)})}
function toggleMode(){$('ipaddr_wrap').style.display=$('mode').value=='static'?'block':'none'}
function toggleKey(){$('key_wrap').style.display=$('passmode').value!='off'?'block':'none'}
function toggleCheck(){$('check_wrap').style.display=$('check').checked?'block':'none'}

function addItem(name,val){
    var list=$(name+'_list'),div=document.createElement('div');
    div.className='dlist-item';
    div.innerHTML='<input type="text" value="'+(val||'')+'" placeholder=""><button type="button" class="del" onclick="this.parentNode.remove()">âœ•</button>';
    list.appendChild(div);
}
function getListValues(name){
    var vals=[];
    $(name+'_list').querySelectorAll('input').forEach(function(inp){if(inp.value)vals.push(inp.value)});
    return vals;
}

function loadConfig(){
    ajax('<%=url("admin/vpn/vnt/get_config")%>',function(r){
        cfg=JSON.parse(r);
        $('enabled').checked=cfg.c_enabled=='1';
        $('token').value=cfg.c_token||'';
        $('mode').value=cfg.c_mode||'dhcp';toggleMode();
        $('ipaddr').value=cfg.c_ipaddr||'';
        $('desvice_id').value=cfg.c_desvice_id||'';
        $('forward').checked=cfg.c_forward=='1';
        $('allow_wg').checked=cfg.c_allow_wg=='1';
        $('log').checked=cfg.c_log=='1';
        $('clibin').value=cfg.c_clibin||'';
        $('vntshost').value=cfg.c_vntshost||'';
        $('desvice_name').value=cfg.c_desvice_name||'';
        $('tunname').value=cfg.c_tunname||'';
        $('relay').value=cfg.c_relay||'è‡ªåŠ¨';
        $('punch').value=cfg.c_punch||'all';
        $('passmode').value=cfg.c_passmode||'off';toggleKey();
        $('key').value=cfg.c_key||'';
        $('client_port').value=cfg.c_client_port||'';
        $('mtu').value=cfg.c_mtu||'';
        $('serverw').checked=cfg.c_serverw=='1';
        $('finger').checked=cfg.c_finger=='1';
        $('first_latency').checked=cfg.c_first_latency=='1';
        $('disable_stats').checked=cfg.c_disable_stats=='1';
        $('check').checked=cfg.c_check=='1';toggleCheck();
        $('checktime').value=cfg.c_checktime||'1';
        
        lists.forEach(function(name){
            var val=cfg['c_'+name];
            if(val){
                if(typeof val=='string')addItem(name,val);
                else if(Array.isArray(val))val.forEach(function(v){addItem(name,v)});
            }else{addItem(name)}
        });
    });
    ajax('<%=url("admin/vpn/vnt/get_ifaces")%>',function(r){
        var ifaces=JSON.parse(r),sel=$('local_dev');
        ifaces.forEach(function(f){var o=document.createElement('option');o.value=f.name;o.textContent=f.name+' ('+f.ip+')';sel.appendChild(o)});
        if(cfg.c_local_dev)sel.value=cfg.c_local_dev;
    });
}

function saveConfig(){
    var data={
        enabled:$('enabled').checked?'1':'0',
        token:$('token').value,
        mode:$('mode').value,
        ipaddr:$('ipaddr').value,
        desvice_id:$('desvice_id').value,
        forward:$('forward').checked?'1':'0',
        allow_wg:$('allow_wg').checked?'1':'0',
        log:$('log').checked?'1':'0',
        clibin:$('clibin').value,
        vntshost:$('vntshost').value,
        desvice_name:$('desvice_name').value,
        tunname:$('tunname').value,
        relay:$('relay').value,
        punch:$('punch').value,
        passmode:$('passmode').value,
        key:$('key').value,
        client_port:$('client_port').value,
        mtu:$('mtu').value,
        local_dev:$('local_dev').value,
        serverw:$('serverw').checked?'1':'0',
        finger:$('finger').checked?'1':'0',
        first_latency:$('first_latency').checked?'1':'0',
        disable_stats:$('disable_stats').checked?'1':'0',
        check:$('check').checked?'1':'0',
        checktime:$('checktime').value
    };
    lists.forEach(function(name){data[name]=getListValues(name)});
    ajax('<%=url("admin/vpn/vnt/save_client")%>',function(){parent.closeModal('settings')},'data='+encodeURIComponent(JSON.stringify(data)));
}

function doUpload(){
    var file=$('upload_file').files[0];
    if(!file)return;
    var fd=new FormData();fd.append('file',file);
    var x=new XMLHttpRequest();
    x.open('POST','<%=url("admin/vpn/vnt/upload")%>',true);
    x.onload=function(){$('upload_status').textContent='ä¸Šä¼ æˆåŠŸ: '+file.name};
    x.send(fd);
    $('upload_status').textContent='ä¸Šä¼ ä¸­...';
}

loadConfig();
</script>
</body></html>
