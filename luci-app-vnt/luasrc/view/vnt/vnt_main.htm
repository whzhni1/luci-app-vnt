<%+header%>
<style>
:root{--c1:#4a90d9;--c2:#28a745;--c3:#dc3545;--c4:#ffc107;--bg:#f8f9fa;--shadow:0 2px 8px rgba(0,0,0,.1)}
*{box-sizing:border-box}
.vnt-wrap{max-width:1200px;margin:0 auto}
.row{display:flex;gap:15px;margin-bottom:15px;flex-wrap:wrap}
.col{flex:1;min-width:300px}
.card{background:#fff;border-radius:8px;box-shadow:var(--shadow);overflow:hidden}
.card-head{background:linear-gradient(135deg,var(--c1),#357abd);color:#fff;padding:12px 15px;display:flex;justify-content:space-between;align-items:center;font-weight:600}
.card-head .icons{display:flex;gap:8px}
.card-head .icons span{cursor:pointer;opacity:.9;font-size:18px;transition:all .2s}
.card-head .icons span:hover{opacity:1;transform:scale(1.1)}
.card-body{padding:15px}
.info-row{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #eee}
.info-row:last-child{border:none}
.info-row .label{color:#666}
.info-row .value{font-weight:500}
.st-on{color:var(--c2)}.st-off{color:var(--c3)}
.md-p2p{color:var(--c2)}.md-relay{color:var(--c4)}
.rt-good{color:var(--c2)}.rt-mid{color:var(--c4)}.rt-bad{color:var(--c3)}

/* æŒ‰é’®ç»„ */
.btn-group{display:flex;gap:10px;padding:15px;background:#f0f0f0;border-radius:8px 8px 0 0}
.btn{padding:10px 20px;border:none;border-radius:6px;cursor:pointer;font-weight:600;transition:all .2s;
    background:linear-gradient(180deg,#fff 0%,#e8e8e8 100%);box-shadow:0 2px 4px rgba(0,0,0,.15),inset 0 1px 0 #fff}
.btn:hover{transform:translateY(-1px);box-shadow:0 4px 8px rgba(0,0,0,.2)}
.btn:active,.btn.active{transform:translateY(1px);box-shadow:inset 0 2px 4px rgba(0,0,0,.1);
    background:linear-gradient(180deg,var(--c1) 0%,#357abd 100%);color:#fff}
.btn-icon{width:36px;height:36px;padding:0;display:flex;align-items:center;justify-content:center;font-size:18px;margin-left:auto}

/* å†…å®¹åŒº */
.content-box{background:#fff;border-radius:0 0 8px 8px;min-height:200px;padding:15px;position:relative}
.dtable{width:100%;border-collapse:collapse}
.dtable th,.dtable td{padding:10px 12px;text-align:left;border-bottom:1px solid #eee}
.dtable th{background:var(--c1);color:#fff}
.dtable tr:hover{background:#f5f5f5}
.empty{text-align:center;padding:40px;color:#999}

/* å¼¹çª— */
.modal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:1000;align-items:center;justify-content:center}
.modal.show{display:flex}
.modal-box{background:#fff;border-radius:10px;width:90%;max-width:800px;max-height:85vh;display:flex;flex-direction:column;box-shadow:0 10px 40px rgba(0,0,0,.3)}
.modal-head{padding:15px 20px;background:linear-gradient(135deg,var(--c1),#357abd);color:#fff;display:flex;justify-content:space-between;align-items:center;border-radius:10px 10px 0 0}
.modal-head h3{margin:0;font-size:18px}
.modal-close{background:none;border:none;color:#fff;font-size:24px;cursor:pointer;opacity:.8}
.modal-close:hover{opacity:1}
.modal-body{flex:1;overflow:auto;padding:0}
.modal-body iframe{width:100%;height:60vh;border:none}
.modal-body.log{padding:15px}
.modal-body.log pre{background:#1e1e1e;color:#d4d4d4;padding:15px;border-radius:6px;margin:0;max-height:50vh;overflow:auto;font-size:13px}
.modal-foot{padding:10px 20px;border-top:1px solid #eee;display:flex;justify-content:flex-end;gap:10px}
</style>

<div class="vnt-wrap">
    <!-- çŠ¶æ€è¡Œ -->
    <div class="row">
        <div class="col">
            <div class="card">
                <div class="card-head">
                    <span>ğŸ“¡ vnt-cli çŠ¶æ€</span>
                    <div class="icons">
                        <span title="æ—¥å¿—" onclick="showLog('client')">ğŸ“</span>
                        <span title="è®¾ç½®" onclick="showSettings('client')">âš™ï¸</span>
                    </div>
                </div>
                <div class="card-body" id="client_status">
                    <div class="info-row"><span class="label">çŠ¶æ€</span><span class="value" id="c_st">-</span></div>
                    <div class="info-row"><span class="label">å·²è¿è¡Œ</span><span class="value" id="c_time">-</span></div>
                    <div class="info-row"><span class="label">èµ„æºå ç”¨</span><span class="value" id="c_res">-</span></div>
                    <div class="info-row"><span class="label">ç‰ˆæœ¬</span><span class="value" id="c_ver">-</span></div>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card">
                <div class="card-head">
                    <span>ğŸ–¥ï¸ vnts çŠ¶æ€</span>
                    <div class="icons">
                        <span title="æ—¥å¿—" onclick="showLog('server')">ğŸ“</span>
                        <span title="Webç®¡ç†" id="web_btn" style="display:none" onclick="openWeb()">ğŸ </span>
                        <span title="è®¾ç½®" onclick="showSettings('server')">âš™ï¸</span>
                    </div>
                </div>
                <div class="card-body" id="server_status">
                    <div class="info-row"><span class="label">çŠ¶æ€</span><span class="value" id="s_st">-</span></div>
                    <div class="info-row"><span class="label">å·²è¿è¡Œ</span><span class="value" id="s_time">-</span></div>
                    <div class="info-row"><span class="label">èµ„æºå ç”¨</span><span class="value" id="s_res">-</span></div>
                    <div class="info-row"><span class="label">ç‰ˆæœ¬</span><span class="value" id="s_ver">-</span></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¿¡æ¯é¢æ¿ -->
    <div class="card" style="margin-bottom:15px">
        <div class="btn-group">
            <button class="btn active" data-tab="list" onclick="switchTab('list')">è®¾å¤‡åˆ—è¡¨</button>
            <button class="btn" data-tab="info" onclick="switchTab('info')">è¿æ¥ä¿¡æ¯</button>
            <button class="btn" data-tab="route" onclick="switchTab('route')">è·¯ç”±è¡¨</button>
            <button class="btn" data-tab="cmd" onclick="switchTab('cmd')">å¯åŠ¨å‚æ•°</button>
            <button class="btn btn-icon" title="åˆ·æ–°" onclick="refreshTab()">ğŸ”„</button>
        </div>
        <div class="content-box" id="tab_content">
            <div class="empty">åŠ è½½ä¸­...</div>
        </div>
    </div>

    <!-- è®¾ç½®æ‘˜è¦ -->
    <div class="row">
        <div class="col">
            <div class="card">
                <div class="card-head">
                    <span>ğŸ“¡ å®¢æˆ·ç«¯è®¾ç½®</span>
                    <div class="icons"><span title="è®¾ç½®" onclick="showSettings('client')">âš™ï¸</span></div>
                </div>
                <div class="card-body">
                    <div class="info-row"><span class="label">Token</span><span class="value" id="c_token">-</span></div>
                    <div class="info-row"><span class="label">æ¥å£æ¨¡å¼</span><span class="value" id="c_mode">-</span></div>
                    <div class="info-row"><span class="label">è™šæ‹ŸIP</span><span class="value" id="c_ip">-</span></div>
                    <div class="info-row"><span class="label">æœåŠ¡å™¨</span><span class="value" id="c_server">-</span></div>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card">
                <div class="card-head">
                    <span>ğŸ–¥ï¸ æœåŠ¡ç«¯è®¾ç½®</span>
                    <div class="icons"><span title="è®¾ç½®" onclick="showSettings('server')">âš™ï¸</span></div>
                </div>
                <div class="card-body">
                    <div class="info-row"><span class="label">ç›‘å¬ç«¯å£</span><span class="value" id="s_port">-</span></div>
                    <div class="info-row"><span class="label">Tokenç™½åå•</span><span class="value" id="s_white">-</span></div>
                    <div class="info-row"><span class="label">DHCPç½‘å…³</span><span class="value" id="s_subnet">-</span></div>
                    <div class="info-row"><span class="label">å­ç½‘æ©ç </span><span class="value" id="s_mask">-</span></div>
                </div>
            </div>
        </div>
    </div>

    <!-- å…³äº -->
    <div class="card">
        <div class="card-body" style="text-align:center;padding:12px">
            <span>â„¹ï¸ <b>VNT</b> - ç®€ä¾¿é«˜æ•ˆçš„å¼‚åœ°ç»„ç½‘å·¥å…·</span> | 
            <a href="http://rustvnt.com" target="_blank">å®˜ç½‘</a> | 
            <a href="https://github.com/vnt-dev/vnt" target="_blank">GitHub</a> | 
            <a href="https://github.com/vnt-dev/VntApp" target="_blank">VntApp</a>
        </div>
    </div>
</div>

<!-- è®¾ç½®å¼¹çª— -->
<div class="modal" id="modal_settings">
    <div class="modal-box">
        <div class="modal-head">
            <h3 id="settings_title">è®¾ç½®</h3>
            <button class="modal-close" onclick="closeModal('settings')">&times;</button>
        </div>
        <div class="modal-body">
            <iframe id="settings_iframe"></iframe>
        </div>
    </div>
</div>

<!-- æ—¥å¿—å¼¹çª— -->
<div class="modal" id="modal_log">
    <div class="modal-box">
        <div class="modal-head">
            <h3 id="log_title">æ—¥å¿—</h3>
            <button class="modal-close" onclick="closeModal('log')">&times;</button>
        </div>
        <div class="modal-body log">
            <pre id="log_content">åŠ è½½ä¸­...</pre>
        </div>
        <div class="modal-foot">
            <button class="btn" onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
            <button class="btn" onclick="refreshLog()">ğŸ”„ åˆ·æ–°</button>
        </div>
    </div>
</div>

<script>
var currentTab = 'list', currentLog = 'client', webPort = 29870;
var tabApis = {list:'vnt_list', info:'vnt_info', route:'vnt_route', cmd:'vnt_cmd'};

function $(id){return document.getElementById(id)}
function ajax(url, cb){
    var x = new XMLHttpRequest();
    x.open('GET', url, true);
    x.onload = function(){cb(x.status==200 ? x.responseText : null)};
    x.send();
}

// çŠ¶æ€åˆ·æ–°
function refreshStatus(){
    ajax('<%=url("admin/vpn/vnt/status")%>', function(r){
        if(!r) return;
        var d = JSON.parse(r);
        $('c_st').innerHTML = d.crunning ? '<span class="st-on">â— è¿è¡Œä¸­</span>' : '<span class="st-off">â— å·²åœæ­¢</span>';
        $('c_time').textContent = d.crunning ? d.vntsta : '-';
        $('c_res').textContent = d.crunning ? 'CPU: '+d.vntcpu+' / å†…å­˜: '+d.vntram : '-';
        $('c_ver').textContent = d.vnttag || '-';
        
        $('s_st').innerHTML = d.srunning ? '<span class="st-on">â— è¿è¡Œä¸­</span>' : '<span class="st-off">â— å·²åœæ­¢</span>';
        $('s_time').textContent = d.srunning ? d.vntsta2 : '-';
        $('s_res').textContent = d.srunning ? 'CPU: '+d.vntscpu+' / å†…å­˜: '+d.vntsram : '-';
        $('s_ver').textContent = d.vntstag || '-';
        
        $('c_token').innerHTML = d.token_set ? '<span class="st-on">âœ“ å·²è®¾ç½®</span>' : '<span class="st-off">âœ— æœªè®¾ç½®</span>';
        $('c_mode').textContent = d.mode=='static' ? 'æ‰‹åŠ¨æŒ‡å®š' : 'åŠ¨æ€åˆ†é…';
        $('c_ip').textContent = d.ipaddr || '-';
        $('c_server').textContent = d.vntshost || '-';
        
        $('s_port').textContent = d.server_port;
        $('s_white').innerHTML = d.white_set ? '<span class="st-on">âœ“ å·²è®¾ç½®</span>' : '<span class="st-off">âœ— æœªè®¾ç½®</span>';
        $('s_subnet').textContent = d.subnet;
        $('s_mask').textContent = d.netmask;
        
        $('web_btn').style.display = d.web==1 ? 'inline' : 'none';
        webPort = d.port;
    });
}

// Tabåˆ‡æ¢
function switchTab(tab){
    currentTab = tab;
    document.querySelectorAll('.btn-group .btn[data-tab]').forEach(function(b){
        b.classList.toggle('active', b.dataset.tab==tab);
    });
    refreshTab();
}

function refreshTab(){
    $('tab_content').innerHTML = '<div class="empty">åŠ è½½ä¸­...</div>';
    ajax('<%=url("admin/vpn/vnt")%>/'+tabApis[currentTab], function(r){
        if(r){
            var d = JSON.parse(r);
            $('tab_content').innerHTML = d.html;
        }else{
            $('tab_content').innerHTML = '<div class="empty">åŠ è½½å¤±è´¥</div>';
        }
    });
}

// å¼¹çª—
function showSettings(type){
    $('settings_title').textContent = (type=='client'?'vnt-cli':'vnts') + ' è®¾ç½®';
    $('settings_iframe').src = '<%=url("admin/vpn/vnt")%>/' + (type=='client'?'client':'server');
    $('modal_settings').classList.add('show');
}

function showLog(type){
    currentLog = type;
    $('log_title').textContent = (type=='client'?'vnt-cli':'vnts') + ' æ—¥å¿—';
    $('modal_log').classList.add('show');
    refreshLog();
}

function closeModal(name){
    $('modal_'+name).classList.remove('show');
    if(name=='settings') refreshStatus();
}

function refreshLog(){
    var api = currentLog=='client' ? 'get_log' : 'get_log2';
    ajax('<%=url("admin/vpn/vnt")%>/'+api, function(r){
        $('log_content').textContent = r || 'æš‚æ— æ—¥å¿—';
        $('log_content').scrollTop = $('log_content').scrollHeight;
    });
}

function clearLog(){
    var api = currentLog=='client' ? 'clear_log' : 'clear_log2';
    ajax('<%=url("admin/vpn/vnt")%>/'+api, function(){refreshLog()});
}

function openWeb(){
    window.open('http://'+location.hostname+':'+webPort, '_blank');
}

// åˆå§‹åŒ–
refreshStatus();
switchTab('list');
setInterval(refreshStatus, 5000);
</script>

<%+footer%>
