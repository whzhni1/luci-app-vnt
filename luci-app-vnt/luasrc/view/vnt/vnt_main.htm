<%+header%>
<style>
:root{--bg:#454141;--card:#454141;--border:#5a5555;--text:#e0e0e0;--text2:#aaa;--accent:#4a90d9;--green:#28a745;--red:#dc3545;--yellow:#ffc107}
.vnt-wrap{max-width:1200px;margin:0 auto;padding:15px}
.row{display:flex;gap:15px;margin-bottom:15px;flex-wrap:wrap}
.col{flex:1;min-width:300px}
.card{background:var(--card);border-radius:8px;border:1px solid var(--border);overflow:hidden}
.card-head{background:linear-gradient(135deg,#3a3636,#2d2a2a);color:#fff;padding:12px 15px;display:flex;justify-content:space-between;align-items:center;font-weight:600}
.card-head .icons{display:flex;gap:10px}
.card-head .icons span{cursor:pointer;opacity:.85;font-size:18px;padding:4px}
.card-head .icons span:hover{opacity:1}
.card-body{padding:15px}
.info-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);color:var(--text)}
.info-row:last-child{border:none}
.info-row .l{color:var(--text2)}.info-row .v{font-weight:500}
.on{color:#28a745!important}.off{color:#dc3545!important}.warn{color:#ffc107!important}
.panel{background:var(--card);border-radius:8px;border:1px solid var(--border);margin-bottom:15px}
.bar{display:flex;gap:8px;padding:12px 15px;background:#3a3636;border-bottom:1px solid var(--border);align-items:center;flex-wrap:wrap}
.btn{padding:8px 18px;border:none;border-radius:5px;cursor:pointer;font-weight:600;font-size:13px;color:#333;background:linear-gradient(180deg,#f0f0f0,#d5d5d5)}
.btn:hover{transform:translateY(-1px)}
.btn.active{background:linear-gradient(180deg,var(--accent),#357abd);color:#fff}
.btn-icon{width:34px;height:34px;padding:0;display:inline-flex;align-items:center;justify-content:center;margin-left:auto;background:linear-gradient(180deg,#555,#444);color:#fff}
.box{min-height:180px;padding:15px;color:var(--text);overflow-x:auto;-webkit-overflow-scrolling:touch}
.dtable{width:100%;border-collapse:collapse;min-width:600px}
.dtable th,.dtable td{padding:10px 12px;text-align:left;border-bottom:1px solid var(--border);white-space:nowrap}
.dtable th{background:#3a3636;color:#fff;font-weight:600}
.dtable tr:hover{background:#4a4545}
.dtable code{background:#333;padding:2px 6px;border-radius:3px}
.empty{text-align:center;padding:40px;color:var(--text2)}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:9999}
.modal.show{display:block}
.mbox{background:#fff;border-radius:8px;display:flex;flex-direction:column;box-shadow:0 10px 40px rgba(0,0,0,.5);position:absolute;overflow:hidden;width:700px;height:550px;max-width:95vw;max-height:85vh}
.mhead{padding:14px 18px;background:var(--accent);color:#fff;display:flex;justify-content:space-between;align-items:center;cursor:move;user-select:none;font-weight:600}
.mhead h3{margin:0;font-size:16px}
.mhead .icons span{cursor:pointer;font-size:18px;margin-left:12px}
.mbody{flex:1;overflow:auto;background:#fff;color:#333;padding:15px}
.mbody.frame{padding:0}
.mbody iframe{width:100%;height:100%;border:none}
.mbody pre{background:#f5f5f5;color:#333;padding:15px;border-radius:6px;border:1px solid #ddd;margin:0;height:100%;overflow:auto;font-size:13px;white-space:pre-wrap;word-break:break-all}
.mfoot{padding:12px 18px;background:#fff;border-top:1px solid #ddd;display:flex;justify-content:flex-end}
.mresize{position:absolute;right:0;bottom:0;width:30px;height:30px;cursor:nwse-resize;background:linear-gradient(135deg,transparent 50%,rgba(0,0,0,.1) 50%)}
.about{background:var(--card);border-radius:8px;border:1px solid var(--border);padding:12px 15px;text-align:center;color:var(--text2)}
.about a{color:var(--accent)}
.toast{position:fixed;top:20px;right:20px;background:#333;color:#fff;padding:12px 20px;border-radius:6px;z-index:10000;display:none}
.toast.show{display:block;animation:fadeIn .3s}
.link{cursor:pointer;color:var(--accent);text-decoration:underline}
.pkg{padding:12px;margin:6px 0;background:#f5f5f5;border:1px solid #ddd;border-radius:6px;cursor:pointer;font-family:monospace;color:#333}
.pkg:hover{background:#e8f4fc;border-color:var(--accent)}
.uinfo{padding:15px;background:#f9f9f9;border-radius:6px;margin-bottom:15px;line-height:1.8;color:#333}
@keyframes fadeIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1}}
@keyframes spin{to{transform:rotate(360deg)}}
.spin{display:inline-block;animation:spin 1s linear infinite}
@media(max-width:768px){.mbox{width:95vw;height:80vh}.dtable{min-width:500px}}
</style>

<div class="vnt-wrap">
    <div class="row" id="status_cards"></div>
    <div class="panel">
        <div class="bar" id="tab_bar"></div>
        <div class="box" id="tab_content"></div>
    </div>
    <div class="row" id="config_cards"></div>
    <div class="about">â„¹ï¸ <b>VNT</b> - ç®€ä¾¿é«˜æ•ˆçš„å¼‚åœ°ç»„ç½‘å·¥å…· | <a href="http://rustvnt.com" target="_blank">å®˜ç½‘</a> | <a href="https://github.com/vnt-dev/vnt" target="_blank">GitHub</a> | <a href="https://github.com/vnt-dev/VntApp" target="_blank">GUIApp</a></div>
</div>

<div class="modal" id="modal"><div class="mbox"><div class="mhead"><h3 id="m_title"></h3><div class="icons" id="m_icons"></div></div><div class="mbody" id="m_body"></div><div class="mfoot" id="m_foot"></div><div class="mresize"></div></div></div>
<div class="toast" id="toast"></div>

<script>
(function(){
var $=function(id){return document.getElementById(id)},
    L='<span class="spin">ğŸ”„</span> åŠ è½½ä¸­...',
    curTab='list',curModal='',webPort=29870,
    ver={c:{l:'-',r:'-'},s:{l:'-',r:'-'}},
    tabs={list:'vnt_list',info:'vnt_info',route:'vnt_route',cmd:'vnt_cmd'},
    cfg={c:{icon:'ğŸ“¡',name:'vnt-cli',type:'client'},s:{icon:'ğŸ–¥ï¸',name:'vnts',type:'server'}};

function ajax(u,d,cb){var x=new XMLHttpRequest();x.open(d?'POST':'GET',u);if(d)x.setRequestHeader('Content-Type','application/x-www-form-urlencoded');x.onload=function(){cb&&cb(x.status==200?x.responseText:null)};x.send(d)}
function toast(m){var t=$('toast');t.textContent=m;t.classList.add('show');setTimeout(function(){t.classList.remove('show')},3000)}
function spin(e,on){e&&e.classList.toggle('spin',on)}
function row(l,v,id,cls){return '<div class="info-row"><span class="l">'+l+'</span><span class="v'+(cls?' '+cls:'')+'"'+(id?' id="'+id+'"':'')+'>'+v+'</span></div>'}

function initCards(){
    var h='';
    ['c','s'].forEach(function(k){
        var c=cfg[k];
        h+='<div class="col"><div class="card"><div class="card-head"><span>'+c.icon+' '+c.name+' çŠ¶æ€</span><div class="icons">';
        h+='<span title="æ—¥å¿—" onclick="showLog(\''+c.type+'\')">ğŸ“</span>';
        if(k=='s')h+='<span title="Webç®¡ç†" id="web_btn" style="display:none" onclick="openWeb()">ğŸ </span>';
        h+='<span title="é‡å¯" onclick="restart(\''+c.type+'\',this)">ğŸ”„</span></div></div><div class="card-body">';
        h+=row('çŠ¶æ€','-',k+'_st');
        h+=row('å·²è¿è¡Œ','-',k+'_time');
        h+=row('èµ„æº','-',k+'_res');
        h+='<div class="info-row"><span class="l">ç‰ˆæœ¬</span><span class="v"><span id="'+k+'_ver" class="link" onclick="showUpdate(\''+c.type+'\')">-</span></span></div>';
        h+='</div></div></div>';
    });
    $('status_cards').innerHTML=h;
    
    h='';
    [{k:'c',t:'Token',m:'æ¥å£æ¨¡å¼',i:'è™šæ‹ŸIP',x:'æœåŠ¡å™¨'},{k:'s',t:'ç›‘å¬ç«¯å£',m:'Tokenç™½åå•',i:'DHCPç½‘å…³',x:'å­ç½‘æ©ç '}].forEach(function(o){
        var c=cfg[o.k];
        h+='<div class="col"><div class="card"><div class="card-head"><span>'+c.icon+' '+(o.k=='c'?'å®¢æˆ·ç«¯':'æœåŠ¡ç«¯')+'è®¾ç½®</span><div class="icons"><span title="è®¾ç½®" onclick="showSettings(\''+c.type+'\',this)">âš™ï¸</span></div></div><div class="card-body">';
        h+=row(o.t,'-',o.k+'_a');h+=row(o.m,'-',o.k+'_b');h+=row(o.i,'-',o.k+'_c');h+=row(o.x,'-',o.k+'_d');
        h+='</div></div></div>';
    });
    $('config_cards').innerHTML=h;
    
    h='';['è®¾å¤‡åˆ—è¡¨','è¿æ¥ä¿¡æ¯','è·¯ç”±è¡¨','å¯åŠ¨å‚æ•°'].forEach(function(n,i){
        var t=['list','info','route','cmd'][i];
        h+='<button class="btn'+(i==0?' active':'')+'" data-tab="'+t+'" onclick="switchTab(\''+t+'\')">'+n+'</button>';
    });
    h+='<button class="btn btn-icon" onclick="refreshTab(this.querySelector(\'span\'))"><span>ğŸ”„</span></button>';
    $('tab_bar').innerHTML=h;
}

function status(){
    ajax('<%=url("admin/vpn/vnt/status")%>',0,function(r){
        if(!r)return;var d=JSON.parse(r);
        ['c','s'].forEach(function(k){
            var run=k=='c'?d.crunning:d.srunning;
            $(k+'_st').innerHTML=run?'<span class="on">â— è¿è¡Œä¸­</span>':'<span class="off">â— å·²åœæ­¢</span>';
            $(k+'_time').textContent=run?(k=='c'?d.vntsta:d.vntsta2):'-';
            $(k+'_res').textContent=run?'CPU:'+(k=='c'?d.vntcpu:d.vntscpu)+' / å†…å­˜:'+(k=='c'?d.vntram:d.vntsram):'-';
            ver[k].l=(k=='c'?d.vnttag:d.vntstag)||'-';
            $(k+'_ver').textContent=ver[k].l+(ver[k].r!='-'?'/'+ver[k].r:'');
        });
        $('c_a').innerHTML=d.token_set?'<span class="on">âœ“ å·²è®¾ç½®</span>':'<span class="off">âœ— æœªè®¾ç½®</span>';
        $('c_b').textContent=d.mode=='static'?'æ‰‹åŠ¨æŒ‡å®š':'åŠ¨æ€åˆ†é…';
        $('c_c').textContent=d.ipaddr||'-';
        $('c_d').textContent=d.vntshost||'-';
        $('s_a').textContent=d.server_port;
        $('s_b').innerHTML=d.white_set?'<span class="on">âœ“ å·²è®¾ç½®</span>':'<span class="off">âœ— æœªè®¾ç½®</span>';
        $('s_c').textContent=d.subnet;
        $('s_d').textContent=d.netmask;
        $('web_btn').style.display=d.web==1?'inline':'none';
        webPort=d.port;
    });
}

function fetchVer(){
    ['vnt','vnts'].forEach(function(n,i){
        var k=i==0?'c':'s';
        ajax('https://gitlab.com/api/v4/projects/whzhni%2F'+n+'/releases',0,function(r){
            if(!r)return;var m=r.match(/"tag_name":"v([^"]+)"/);
            ver[k].r=m?m[1]:'-';
            $(k+'_ver').textContent=ver[k].l+(ver[k].r!='-'?'/'+ver[k].r:'');
        });
    });
}

function modal(title,body,foot,icons){
    $('m_title').textContent=title;
    $('m_body').className='mbody'+(body.iframe?' frame':'');
    $('m_body').innerHTML=body.iframe?'<iframe src="'+body.iframe+'"></iframe>':(body.html||'');
    $('m_foot').innerHTML=foot||'';
    $('m_icons').innerHTML=(icons||'')+'<span onclick="closeModal()">âœ•</span>';
    var m=$('modal'),b=m.querySelector('.mbox');
    m.classList.add('show');
    b.style.left=(innerWidth-b.offsetWidth)/2+'px';
    b.style.top=(innerHeight-b.offsetHeight)/2+'px';
    initDrag(b);initResize(b);
}

function closeModal(){
    $('modal').classList.remove('show');
    $('m_body').innerHTML='';
    if(curModal=='settings')status();
    curModal='';
}
window.closeModal=closeModal;

function initDrag(b){
    var h=b.querySelector('.mhead'),dragging=false,ox,oy,bx,by;
    function start(e){
        if(e.target.tagName=='SPAN')return;
        e.preventDefault();
        dragging=true;
        var p=e.touches?e.touches[0]:e;
        ox=p.clientX;oy=p.clientY;bx=b.offsetLeft;by=b.offsetTop;
        document.body.style.overflow='hidden';
    }
    function move(e){
        if(!dragging)return;
        e.preventDefault();
        var p=e.touches?e.touches[0]:e;
        b.style.left=Math.max(100-b.offsetWidth,Math.min(innerWidth-100,bx+p.clientX-ox))+'px';
        b.style.top=Math.max(0,Math.min(innerHeight-50,by+p.clientY-oy))+'px';
    }
    function end(){
        dragging=false;
        document.body.style.overflow='';
    }
    h.onmousedown=start;h.ontouchstart=start;
    document.addEventListener('mousemove',move);
    document.addEventListener('touchmove',move,{passive:false});
    document.addEventListener('mouseup',end);
    document.addEventListener('touchend',end);
}

function initResize(b){
    var r=b.querySelector('.mresize'),resizing=false,ow,oh,ox,oy;
    function start(e){
        e.preventDefault();e.stopPropagation();
        resizing=true;
        var p=e.touches?e.touches[0]:e;
        ow=b.offsetWidth;oh=b.offsetHeight;ox=p.clientX;oy=p.clientY;
    }
    function move(e){
        if(!resizing)return;
        e.preventDefault();
        var p=e.touches?e.touches[0]:e;
        b.style.width=Math.max(320,ow+p.clientX-ox)+'px';
        b.style.height=Math.max(200,oh+p.clientY-oy)+'px';
    }
    function end(){resizing=false}
    r.onmousedown=start;r.ontouchstart=start;
    document.addEventListener('mousemove',move);
    document.addEventListener('touchmove',move,{passive:false});
    document.addEventListener('mouseup',end);
    document.addEventListener('touchend',end);
}

window.switchTab=function(t){curTab=t;document.querySelectorAll('.btn[data-tab]').forEach(function(b){b.classList.toggle('active',b.dataset.tab==t)});refreshTab()};
window.refreshTab=function(e){spin(e,1);$('tab_content').innerHTML='<div class="empty">'+L+'</div>';ajax('<%=url("admin/vpn/vnt")%>/'+tabs[curTab],0,function(r){$('tab_content').innerHTML=r?JSON.parse(r).html:'<div class="empty">åŠ è½½å¤±è´¥</div>';spin(e,0)})};

window.showLog=function(t){
    curModal=t;var k=t=='client'?'c':'s';
    modal(cfg[k].name+' æ—¥å¿—',{html:'<pre id="log_pre">'+L+'</pre>'},'<button class="btn" onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>','<span onclick="refreshLog(this)">ğŸ”„</span>');
    refreshLog();
};
window.refreshLog=function(e){
    spin(e,1);
    ajax('<%=url("admin/vpn/vnt")%>/'+(curModal=='client'?'get_log':'get_log2'),0,function(r){
        var p=$('log_pre');if(p){p.textContent=r||'æš‚æ— æ—¥å¿—';p.scrollTop=9e9}spin(e,0);
    });
};
window.clearLog=function(){ajax('<%=url("admin/vpn/vnt")%>/'+(curModal=='client'?'clear_log':'clear_log2'),0,function(){refreshLog();toast('æ—¥å¿—å·²æ¸…é™¤')})};

window.showSettings=function(t,e){
    spin(e,1);curModal='settings';var k=t=='client'?'c':'s';
    modal(cfg[k].name+' è®¾ç½®',{iframe:'<%=url("admin/vpn/vnt")%>/popup_'+(t=='client'?'client':'server')});
    $('m_body').querySelector('iframe').onload=function(){spin(e,0)};
};

window.restart=function(t,e){
    spin(e,1);var k=t=='client'?'c':'s';
    toast(cfg[k].name+' æ­£åœ¨é‡å¯...');
    ajax('<%=url("admin/vpn/vnt/restart")%>','type='+t,function(){setTimeout(function(){status();spin(e,0)},2000)});
};

window.showUpdate=function(t){
    curModal='update';var k=t=='client'?'c':'s',name=t=='client'?'vnt':'vnts';
    modal(cfg[k].name+' æ›´æ–°',{html:'<div class="uinfo" id="u_info">'+L+'</div><div id="u_list"></div>'});
    ajax('<%=url("admin/vpn/vnt/get_update")%>','type='+t,function(r){
        if(!r){$('u_info').textContent='è·å–å¤±è´¥';return}
        var d=JSON.parse(r);
        $('u_info').innerHTML='<b>æœ€æ–°ç‰ˆæœ¬:</b> v'+d.version+'<br><b>åŒ…ç®¡ç†å™¨:</b> '+d.mgr+'<br><b>ç³»ç»Ÿæ¶æ„:</b> '+d.arch;
        if(!d.files||!d.files.length){$('u_list').innerHTML='<div class="empty">æœªæ‰¾åˆ°å®‰è£…åŒ…</div>';return}
        var h='';d.files.forEach(function(f){h+='<div class="pkg" onclick="installPkg(\''+t+'\',\''+f+'\')">'+f+'</div>'});
        $('u_list').innerHTML=h;
    });
};

window.installPkg=function(t,f){
    if(!confirm('ç¡®å®šå®‰è£… '+f+' ?'))return;
    $('u_list').innerHTML = '<div style="text-align:center; padding:40px; color: #333">' + L.replace('åŠ è½½ä¸­','ä¸‹è½½å®‰è£…ä¸­') + '</div>';
    ajax('<%=url("admin/vpn/vnt/do_install")%>','type='+t+'&file='+encodeURIComponent(f),function(r){
        var d=r?JSON.parse(r):{status:'error',msg:'è¯·æ±‚å¤±è´¥'};
        $('u_list').innerHTML='<div class="empty" style="color:'+(d.status=='ok'?'#28a745':'#dc3545')+'">'+(d.status=='ok'?'âœ“ å®‰è£…å®Œæˆ<pre>'+d.msg+'</pre>':'âœ— '+d.msg)+'</div>';
        if(d.status=='ok')setTimeout(status,2000);
    });
};

window.openWeb=function(){window.open('http://'+location.hostname+':'+webPort)};

initCards();status();fetchVer();switchTab('list');setInterval(status,5000);
})();
</script>
<%+footer%>
