<%+header%>
<style>
:root{
    --bg:#e9ecef;
    --text-main:#333;
    --shadow-out:7px 7px 12px rgba(0,0,0,.4),-7px -7px 12px rgba(255,255,255,.9);
    --shadow-in:inset -7px -7px 12px rgba(255,255,255,.9),inset 7px 7px 12px rgba(0,0,0,.4);
    --c-on:#52c41a;
    --c-off:#ff4d4f;
    --c-link:#1677ff;
    --c-warn:#faad14
}
body{background:var(--bg);color:var(--text-main);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;line-height:1.5;margin:0}
*{box-sizing:border-box}
.vnt-wrap{max-width:1200px;margin:0 auto;padding:20px}
.row{display:flex;gap:20px;margin-bottom:20px;flex-wrap:wrap}
.col{flex:1;min-width:300px}
.card{background:var(--bg);border-radius:15px;padding:20px;box-shadow:var(--shadow-out);transition:.2s all;border:none}
.card:hover{box-shadow:9px 9px 15px rgba(0,0,0,.4),-9px -9px 15px rgba(255,255,255,.9)}
.card-head{color:var(--text-main);padding:0 0 15px 0;display:flex;justify-content:space-between;align-items:center;font-weight:600;font-size:16px}
.card-head .icons{display:flex;gap:12px}
.card-head .icons span{cursor:pointer;opacity:.8;font-size:18px;width:36px;height:36px;border-radius:50%;background:var(--bg);box-shadow:5px 5px 8px rgba(0,0,0,.3),-5px -5px 8px rgba(255,255,255,.9);display:inline-flex;align-items:center;justify-content:center;transition:.2s all}
.card-head .icons span:active{box-shadow:var(--shadow-in);transform:translateY(0)}
.card-head .icons span:hover{opacity:1;color:var(--c-link)}
.card-body{padding-top:5px}
.info-row{display:flex;justify-content:space-between;padding:12px 0;padding-bottom:0}
.info-row:last-child{padding-bottom:12px}
.info-row .l{color:#666;font-weight:400}
.info-row .v{font-weight:600;color:var(--text-main)}
.on{color:var(--c-on)!important}
.off{color:var(--c-off)!important}
.warn{color:var(--c-warn)!important}
.link{color:var(--c-link);cursor:pointer;font-weight:500}
.link:hover{text-decoration:underline}
.panel{background:var(--bg);border-radius:15px;padding:15px;box-shadow:var(--shadow-in);border:none}
.bar{display:flex;gap:15px;padding:10px;align-items:center;flex-wrap:wrap}
.bar .btn-icon:last-child{margin-left:auto}
.btn{padding:10px 24px;border:none;border-radius:10px;background:var(--bg);color:var(--text-main);cursor:pointer;box-shadow:var(--shadow-out);outline:none;font-weight:500;transition:.2s all}
.btn:hover{color:var(--c-link)}
.btn:active,.btn.active{box-shadow:var(--shadow-in);transform:translateY(0);color:var(--c-link);font-weight:600}
.btn-icon{width:42px;height:42px;border-radius:50%;background:var(--bg);color:var(--text-main);border:none;cursor:pointer;box-shadow:var(--shadow-out);padding:0;display:flex;align-items:center;justify-content:center;transition:.2s all}
.btn-icon:active{box-shadow:var(--shadow-in);transform:translateY(0)}
.btn-icon:hover{color:var(--c-link)}
.btn-icon span{display:flex;align-items:center;justify-content:center;width:100%;height:100%;font-size:18px}
.box{min-height:350px;padding:20px;color:var(--text-main);overflow-x:auto;-webkit-overflow-scrolling:touch}
.dtable{width:100%;border-collapse:collapse;font-size:14px;min-width:600px}
.dtable th,.dtable td{padding:16px;text-align:left;color:var(--text-main);background:transparent}
.dtable th{font-weight:600;border-bottom:2px solid rgba(0,0,0,.05)}
.dtable tr{border-bottom:1px solid rgba(0,0,0,.03)}
code{background:transparent;color:inherit;border:none;padding:0;margin:0;box-shadow:none;font-family:inherit;font-size:inherit;display:inline}
textarea,input,select,pre{background:var(--bg);color:var(--text-main);border:none;outline:none;padding:15px;border-radius:8px;width:100%;box-shadow:var(--shadow-in);font-family:Consolas,monospace,"Courier New";margin:10px 0;resize:vertical}
.empty{display:flex;flex-direction:column;justify-content:center;align-items:center;height:100%;min-height:350px;color:#999;width:100%;background:rgba(255,255,255,.4);border-radius:15px;box-shadow:var(--shadow-in)}
.mbox{display:none;position:fixed;background:var(--bg);border-radius:15px;box-shadow:10px 10px 20px rgba(0,0,0,.4),-10px -10px 20px rgba(255,255,255,.9);z-index:9999;width:850px;height:650px;max-width:95vw;max-height:90vh;flex-direction:column;top:50%;left:50%;transform:translate(-50%,-50%);border:none}
.mbox.show{display:flex}
.mhead{padding:16px 24px;color:var(--text-main);display:flex;justify-content:space-between;align-items:center;cursor:move;user-select:none;font-weight:600;border-bottom:1px solid rgba(0,0,0,.06)}
.mhead:active{user-select:none}
.mhead h3{margin:0;font-size:16px;pointer-events:none;color:#000}
.mhead .icons span{cursor:pointer;font-size:18px;margin-left:12px;opacity:.6;color:#000;background:var(--bg);box-shadow:5px 5px 8px rgba(0,0,0,.3),-5px -5px 8px rgba(255,255,255,.9);border-radius:50%;width:32px;height:32px;display:inline-flex;align-items:center;justify-content:center;transition:.2s all}
.mhead .icons span:hover{opacity:1;color:var(--c-link)}
.mhead .icons span:active{box-shadow:var(--shadow-in);transform:translateY(0)}
.mbody{flex:1;overflow:auto;background:rgba(255,255,255,.4);color:var(--text-main);padding:20px;position:relative;border-radius:0 0 15px 15px}
.mbody iframe{width:100%;height:100%;border:none}
.mfoot{padding:16px 24px;background:var(--bg);border-top:1px solid rgba(0,0,0,.06);display:flex;justify-content:flex-end;gap:15px;border-radius:0 0 15px 15px;z-index:10}
.mresize{position:absolute;right:0;bottom:0;width:30px;height:30px;cursor:nwse-resize;background:linear-gradient(135deg,transparent 50%,#ccc 50%);border-bottom-right-radius:15px;opacity:.5;z-index:10}
.mresize:hover{opacity:1}
.about{background:var(--bg);border-radius:15px;padding:16px;text-align:center;color:#666;font-size:13px;box-shadow:var(--shadow-in)}
.about a{color:var(--c-link);text-decoration:none;margin:0 5px;font-weight:500}
.about a:hover{text-decoration:underline}
.toast{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--bg);color:var(--text-main);padding:12px 24px;border-radius:8px;z-index:10001;display:none;box-shadow:var(--shadow-out);font-size:14px;font-weight:500}
.toast.show{display:block;animation:slideIn .3s cubic-bezier(.23,1,.32,1)}
.pkg{padding:16px;margin:10px 0;background:var(--bg);border-radius:10px;cursor:pointer;font-family:monospace;color:var(--text-main);transition:.2s all;display:flex;align-items:center;justify-content:space-between;box-shadow:var(--shadow-out);border:none}
.pkg:hover{transform:translateY(-2px);color:var(--c-link)}
.pkg:active{box-shadow:var(--shadow-in);transform:translateY(0)}
.uinfo{padding:20px;background:rgba(255,255,255,.5);border-radius:10px;margin-bottom:20px;line-height:1.8;color:var(--text-main);box-shadow:var(--shadow-in)}
.spin{display:inline-flex;align-items:center;justify-content:center;animation:spin 1s linear infinite;width:1em;height:1em;vertical-align:middle}
.btn-modal{padding:8px 20px;border-radius:10px;background:var(--bg);color:#555;border:none;cursor:pointer;font-size:14px;transition:.2s all;box-shadow:var(--shadow-out);font-weight:500}
.btn-modal:hover{color:var(--c-link)}
.btn-modal.primary{color:var(--c-link);font-weight:600}
.btn-modal:active{box-shadow:var(--shadow-in)}
@media(max-width:768px){.mbox{width:95vw;height:80vh}.vnt-wrap{padding:10px}}
@keyframes slideIn{from{opacity:0;transform:translate(-50%,-50%) scale(0.8)}to{opacity:1;transform:translate(-50%,-50%) scale(1)}}
@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
</style>

<div class="vnt-wrap">
    <div class="row" id="status_cards"></div>
    <div class="panel">
        <div class="bar" id="tab_bar"></div>
        <div class="box" id="tab_content"></div>
    </div>
    <div class="row" id="config_cards"></div>
    <div class="about">â„¹ï¸ <b>VNT</b> - ç®€ä¾¿é«˜æ•ˆçš„å¼‚åœ°ç»„ç½‘å·¥å…· | <a href="http://rustvnt.com" target="_blank">å®˜ç½‘</a> | <a href="https://github.com/vnt-dev/vnt" target="_blank">GitHub</a> | <a href="https://github.com/vnt-dev/VntApp" target="_blank">GUIApp</a></div>
</div>

<div class="mbox" id="mbox"><div class="mhead"><h3 id="m_title"></h3><div class="icons" id="m_icons"></div></div><div class="mbody" id="m_body"></div><div class="mfoot" id="m_foot"></div><div class="mresize"></div></div>
<div class="toast" id="toast"></div>

<script>
(function(){
var $=function(id){return document.getElementById(id)},
L='<span class="spin">ğŸ”„</span> åŠ è½½ä¸­...',
curTab='list',curModal='',webPort=29870,spinEl=null,
ver={c:{l:'-',r:'-'},s:{l:'-',r:'-'}},
tabs={list:'vnt_list',info:'vnt_info',route:'vnt_route',chart:'vnt_chart',cmd:'vnt_cmd'},
cfg={c:{icon:'ğŸ“¡',name:'vnt-cli',type:'client'},s:{icon:'ğŸ–¥ï¸',name:'vnts',type:'server'}},
winState={w:800,h:600,l:'',t:'',isCenter:true,isFull:false};

function ajax(u,d,cb){var x=new XMLHttpRequest();x.open(d?'POST':'GET',u);if(d)x.setRequestHeader('Content-Type','application/x-www-form-urlencoded');x.onload=function(){cb&&cb(x.status==200?x.responseText:null)};x.send(d)}
function toast(m){var t=$('toast');t.textContent=m;t.classList.add('show');setTimeout(function(){t.classList.remove('show')},3000)}
function spin(e,on){if(e)e.classList.toggle('spin',on)}

function processTableColors(){
    var cells=document.querySelectorAll('.dtable td, .dtable tr');
    if(cells.length==0) return;
    for(var i=0;i<cells.length;i++){
        var el=cells[i];
        var t=el.textContent||el.innerText;
        if(t.indexOf('åœ¨çº¿')>-1||t.indexOf('â—è¿è¡Œä¸­')>-1||t.indexOf('Running')>-1){
            el.style.color='var(--c-on)';
        } else if(t.indexOf('ç¦»çº¿')>-1||t.indexOf('â—ç¦»çº¿')>-1||t.indexOf('Offline')>-1||t.indexOf('stopped')>-1){
            el.style.color='var(--c-off)';
        }
        var ms=t.match(/(\d+)\s*ms/);
        if(ms){
            var v=parseInt(ms[1]);
            if(v<100) el.style.color='var(--c-on)';
            else if(v<300) el.style.color='var(--c-warn)';
            else el.style.color='var(--c-off)';
        }
    }
}

function row(l,v,id,cls){return '<div class="info-row"><span class="l">'+l+'</span><span class="v'+(cls?' '+cls:'')+'"'+(id?' id="'+id+'"':'')+'>'+v+'</span></div>'}

function initCards(){
    var h='';
    ['c','s'].forEach(function(k){
        var c=cfg[k];
        h+='<div class="col"><div class="card"><div class="card-head"><span>'+c.icon+' '+c.name+' çŠ¶æ€</span><div class="icons">';
        h+='<span title="æ—¥å¿—" onclick="showLog(\''+c.type+'\')">ğŸ“</span>';
        if(k=='s')h+='<span title="Webç®¡ç†" id="web_btn" style="display:none" onclick="openWeb()">ğŸ </span>';
        h+='<span title="é‡å¯" onclick="restart(\''+c.type+'\',this)">ğŸ”„</span></div></div><div class="card-body">';
        h+=row('çŠ¶æ€','-',k+'_st');
        h+=row('è¿è¡Œæ—¶é•¿','-',k+'_time');
        h+=row('èµ„æºå ç”¨','-',k+'_res');
        h+='<div class="info-row"><span class="l">ç‰ˆæœ¬</span><span class="v"><span id="'+k+'_ver" class="link" onclick="showUpdate(\''+c.type+'\')">-</span></span></div>';
        h+='</div></div></div>';
    });
    $('status_cards').innerHTML=h;
  
    h='';
    [{k:'c',t:'Token',m:'æ¥å£æ¨¡å¼',i:'è™šæ‹ŸIP',x:'æœåŠ¡å™¨åœ°å€'},{k:'s',t:'ç›‘å¬ç«¯å£',m:'Tokenç™½åå•',i:'DHCPç½‘å…³',x:'å­ç½‘æ©ç '}].forEach(function(o){
        var c=cfg[o.k];
        h+='<div class="col"><div class="card"><div class="card-head"><span>'+c.icon+' '+(o.k=='c'?'å®¢æˆ·ç«¯':'æœåŠ¡ç«¯')+'é…ç½®</span><div class="icons"><span title="è®¾ç½®" onclick="showSettings(\''+c.type+'\',this)">âš™ï¸</span></div></div><div class="card-body">';
        h+=row(o.t,'-',o.k+'_a');h+=row(o.m,'-',o.k+'_b');h+=row(o.i,'-',o.k+'_c');h+=row(o.x,'-',o.k+'_d');
        h+='</div></div></div>';
    });
    $('config_cards').innerHTML=h;
  
    h='';['è®¾å¤‡åˆ—è¡¨','è¿æ¥ä¿¡æ¯','è·¯ç”±è¡¨','æµé‡ç»Ÿè®¡','å¯åŠ¨å‚æ•°'].forEach(function(n,i){
        var t=['list','info','route','chart','cmd'][i];
        h+='<button class="btn'+(i==0?' active':'')+'" data-target="'+t+'" onclick="switchTab(\''+t+'\')">'+n+'</button>';
    });
    h+='<button class="btn-icon" onclick="refreshTab(this)"><span>ğŸ”„</span></button>';
    $('tab_bar').innerHTML=h;
}

function status(){
    ajax('<%=url("admin/vpn/vnt/status")%>',0,function(r){
        if(!r)return;var d=JSON.parse(r);
        ['c','s'].forEach(function(k){
            var run=k=='c'?d.crunning:d.srunning;
            var cls=run?'on':'off';
            var txt=run?'â— è¿è¡Œä¸­':'â— å·²åœæ­¢';
            $(k+'_st').innerHTML='<span class="'+cls+'">'+txt+'</span>';
            $(k+'_time').textContent=run?(k=='c'?d.vntsta:d.vntsta2):'-';
            $(k+'_res').textContent=run?'CPU:'+(k=='c'?d.vntcpu:d.vntscpu)+' å†…å­˜:'+(k=='c'?d.vntram:d.vntsram):'-';
            ver[k].l=(k=='c'?d.vnttag:d.vntstag)||'-';
            $(k+'_ver').textContent=ver[k].l+(ver[k].r!='-'?'/'+ver[k].r:'');
        });
        $('c_a').innerHTML=d.token_set?'<span class="on">âœ“ å·²è®¾ç½®</span>':'<span class="off">âœ— æœªè®¾ç½®</span>';
        $('c_b').textContent=d.mode=='static'?'æ‰‹åŠ¨æŒ‡å®š':'åŠ¨æ€åˆ†é…';
        $('c_c').textContent=d.ipaddr||'-';
        $('c_d').textContent=d.vntshost||'-';
        $('s_a').textContent=d.server_port;
        $('s_b').innerHTML=d.white_set?'<span class="on">âœ“ å·²è®¾ç½®</span>':'<span class="off">âœ— æœªè®¾ç½®</span>';
        $('s_c').textContent=d.subnet;
        $('s_d').textContent=d.netmask;
        $('web_btn').style.display=d.web==1?'inline-flex':'none';
        webPort=d.port;
    });
}

function fetchVer(){
    ['vnt','vnts'].forEach(function(n,i){
        var k=i==0?'c':'s';
        ajax('https://gitlab.com/api/v4/projects/whzhni%2F'+n+'/releases',0,function(r){
            if(!r)return;var m=r.match(/"tag_name":"v([^"]+)"/);
            ver[k].r=m?m[1]:'-';
            $(k+'_ver').textContent=ver[k].l+(ver[k].r!='-'?'/'+ver[k].r:'');
        });
    });
}

function modal(title,body,foot,icons){
    var b=$('mbox');
    resetModal();
    $('m_title').textContent=title;
    var mb=$('m_body');
    mb.innerHTML='';
    mb.className='mbody';
    $('m_foot').innerHTML=foot||'';
    $('m_icons').innerHTML='<span onclick="toggleFull()">â›¶</span>'+(icons||'')+'<span onclick="closeModal()">âœ•</span>';
    if(body.iframe){
        mb.innerHTML='<div id="m_loader" class="empty" style="position:absolute;inset:0;background:var(--bg);z-index:1">'+L+'</div><iframe id="m_iframe" style="width:100%;height:100%;border:none"></iframe>';
        var ifm=$('m_iframe');
        ifm.onload=function(){
            var ld=$('m_loader');if(ld)ld.remove();
            if(spinEl){spin(spinEl,0);spinEl=null}
        };
        ifm.src=body.iframe;
    }else{
        mb.innerHTML=body.html||'';
    }
    b.classList.add('show');
    initDrag(b);initResize(b);
}

function resetModal(){
    var b=$('mbox');
    b.classList.remove('show');
    b.style.top='50%';
    b.style.left='50%';
    b.style.transform='translate(-50%,-50%)';
    b.style.width='';
    b.style.height='';
    b.style.margin='0';
    b.style.borderRadius='15px';
    winState.isFull=false;
    winState.isCenter=true;
    winState.l='';winState.t='';winState.w='';winState.h='';
}

function closeModal(){
    resetModal();
    $('m_body').innerHTML='';
    if(spinEl){spin(spinEl,0);spinEl=null}
    if(curModal=='settings')status();
    curModal='';
}
window.closeModal=closeModal;

window.toggleFull=function(){
    var b=$('mbox');
    if(!winState.isFull){
        var rect=b.getBoundingClientRect();
        winState.w=b.style.width||rect.width+'px';
        winState.h=b.style.height||rect.height+'px';
        if(b.style.transform && b.style.transform !== 'none'){
            winState.isCenter=true;
            winState.l='';winState.t='';
        }else{
            winState.isCenter=false;
            winState.l=b.style.left;
            winState.t=b.style.top;
        }
        winState.isFull=true;
        b.style.transform='none';
        b.style.left='0';
        b.style.top='0';
        b.style.width='100vw';
        b.style.height='100vh';
        b.style.margin='0';
        b.style.borderRadius='0';
    }else{
        winState.isFull=false;
        b.style.width=winState.w;
        b.style.height=winState.h;
        b.style.borderRadius='15px';
        if(winState.isCenter){
            b.style.left='50%';
            b.style.top='50%';
            b.style.transform='translate(-50%,-50%)';
            b.style.margin='0';
        }else{
            b.style.transform='none';
            b.style.left=winState.l;
            b.style.top=winState.t;
            b.style.margin='0';
        }
    }
};

function initDrag(b){
    var h=b.querySelector('.mhead'),dragging=false,ox,oy,bx,by;
    function start(e){
        if(e.target.tagName==='SPAN'||e.target.closest('span'))return;
        if(winState.isFull) return;
        if(b.style.transform && b.style.transform !== 'none'){
            var r=b.getBoundingClientRect();
            b.style.transform='none';
            b.style.left=r.left+'px';
            b.style.top=r.top+'px';
            b.style.margin='0';
            winState.isCenter=false;
        }
        e.preventDefault();dragging=true;
        var p=e.touches?e.touches[0]:e;
        ox=p.clientX;oy=p.clientY;bx=parseInt(b.style.left)||0;by=parseInt(b.style.top)||0;
    }
    function move(e){
        if(!dragging)return;
        e.preventDefault();
        var p=e.touches?e.touches[0]:e;
        b.style.left=(bx+p.clientX-ox)+'px';
        b.style.top=(by+p.clientY-oy)+'px';
    }
    function end(){dragging=false}
    h.onmousedown=start;h.ontouchstart=start;
    document.addEventListener('mousemove',move);
    document.addEventListener('touchmove',move,{passive:false});
    document.addEventListener('mouseup',end);
    document.addEventListener('touchend',end);
}

function initResize(b){
    var r=b.querySelector('.mresize'),resizing=false,ow,oh,ox,oy;
    function start(e){
        if(winState.isFull) return;
        if(b.style.transform && b.style.transform !== 'none'){
            var rect=b.getBoundingClientRect();
            b.style.transform='none';
            b.style.left=rect.left+'px';
            b.style.top=rect.top+'px';
            b.style.margin='0';
            winState.isCenter=false;
        }
        e.preventDefault();e.stopPropagation();resizing=true;
        var p=e.touches?e.touches[0]:e;
        ow=b.offsetWidth;oh=b.offsetHeight;ox=p.clientX;oy=p.clientY;
    }
    function move(e){
        if(!resizing)return;
        e.preventDefault();
        var p=e.touches?e.touches[0]:e;
        b.style.width=Math.max(300,ow+p.clientX-ox)+'px';
        b.style.height=Math.max(200,oh+p.clientY-oy)+'px';
    }
    function end(){resizing=false}
    r.onmousedown=start;r.ontouchstart=start;
    document.addEventListener('mousemove',move);
    document.addEventListener('touchmove',move,{passive:false});
    document.addEventListener('mouseup',end);
    document.addEventListener('touchend',end);
}

window.switchTab=function(t){curTab=t;document.querySelectorAll('.btn[data-target]').forEach(function(b){b.classList.toggle('active',b.dataset.target==t)});refreshTab()};

window.refreshTab=function(btn){
    if(btn)spin(btn.querySelector('span'),1);
    $('tab_content').innerHTML='<div class="empty">'+L+'</div>';
    ajax('<%=url("admin/vpn/vnt")%>/'+tabs[curTab],0,function(r){
        $('tab_content').innerHTML=r?JSON.parse(r).html:'<div class="empty">åŠ è½½å¤±è´¥</div>';
        processTableColors();
        if(btn)spin(btn.querySelector('span'),0);
    })
};

window.showLog=function(t){
    curModal=t;var k=t=='client'?'c':'s';
    modal(cfg[k].name+' æ—¥å¿—',{html:'<pre id="log_pre" style="width:100%;height:100%;margin:0;">'+L+'</pre>'},'<button class="btn-modal primary" onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>','<span onclick="refreshLog(this)">ğŸ”„</span>');
    refreshLog();
};
window.refreshLog=function(e){
    if(e)spin(e,1);
    ajax('<%=url("admin/vpn/vnt")%>/'+(curModal=='client'?'get_log':'get_log2'),0,function(r){
        var p=$('log_pre');if(p){p.textContent=r||'æš‚æ— æ—¥å¿—';p.scrollTop=9e9}if(e)spin(e,0);
    });
};
window.clearLog=function(){ajax('<%=url("admin/vpn/vnt")%>/'+(curModal=='client'?'clear_log':'clear_log2'),0,function(){refreshLog();toast('æ—¥å¿—å·²æ¸…é™¤')})};

window.showSettings=function(t,e){
    var target=e.currentTarget?e.currentTarget:e;
    if(!target.querySelector('.spin')){spin(target,1);spinEl=target;}
    curModal='settings';var k=t=='client'?'c':'s';
    modal(cfg[k].name+' è®¾ç½®',{iframe:'<%=url("admin/vpn/vnt")%>/popup_'+(t=='client'?'client':'server')});
};

window.restart=function(t,e){
    var target=e.currentTarget?e.currentTarget:e;
    spin(target,1);var k=t=='client'?'c':'s';
    toast(cfg[k].name+' æ­£åœ¨é‡å¯...');
    ajax('<%=url("admin/vpn/vnt/restart")%>','type='+t,function(){setTimeout(function(){status();spin(target,0)},2000)});
};

window.showUpdate=function(t){
    curModal='update';var k=t=='client'?'c':'s';
    modal(cfg[k].name+' æ›´æ–°',{html:'<div class="uinfo" id="u_info">'+L+'</div><div id="u_list"></div>'});
    ajax('<%=url("admin/vpn/vnt/get_update")%>','type='+t,function(r){
        if(!r){$('u_info').textContent='è·å–å¤±è´¥';return}
        var d=JSON.parse(r);
        $('u_info').innerHTML='<b>æœ€æ–°ç‰ˆæœ¬:</b> v'+d.version+'<br><b>åŒ…ç®¡ç†å™¨:</b> '+d.mgr+'<br><b>ç³»ç»Ÿæ¶æ„:</b> '+d.arch;
        if(!d.files||!d.files.length){$('u_list').innerHTML='<div class="empty">æœªæ‰¾åˆ°å®‰è£…åŒ…</div>';return}
        var h='';d.files.forEach(function(f){h+='<div class="pkg" onclick="installPkg(\''+t+'\',\''+f+'\')"><span>'+f+'</span><span>â¬‡ï¸</span></div>'});
        $('u_list').innerHTML=h;
    });
};

window.installPkg=function(t,f){
    if(!confirm('ç¡®å®šå®‰è£… '+f+' ?'))return;
    $('u_list').innerHTML = '<div class="empty"><span class="spin">ğŸ”„</span> ä¸‹è½½å®‰è£…ä¸­...</div>';
    ajax('<%=url("admin/vpn/vnt/do_install")%>','type='+t+'&file='+encodeURIComponent(f),function(r){
        var d=r?JSON.parse(r):{status:'error',msg:'è¯·æ±‚å¤±è´¥'};
        var color=d.status=='ok'?'var(--c-on)':'var(--c-off)';
        $('u_list').innerHTML='<div class="empty" style="color:'+color+'">'+(d.status=='ok'?'âœ“ å®‰è£…å®Œæˆ<pre style="width:100%">'+d.msg+'</pre>':'âœ— '+d.msg)+'</div>';
        if(d.status=='ok')setTimeout(status,2000);
    });
};

window.openWeb=function(){window.open('http://'+location.hostname+':'+webPort)};

initCards();status();fetchVer();switchTab('list');setInterval(status,5000);
})();
</script>
<%+footer%>
